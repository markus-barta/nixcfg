---
description: Prevent security-critical data from being committed to Git
globs: "**/*"
alwaysApply: true
---

# Git Security Policy

## ğŸ”’ CRITICAL RULE: Never Commit Security-Critical Data

**NEVER** commit, stage, or include in Git operations any of the following:

### â›” Absolutely Forbidden

**Passwords & Credentials**:
- Plain text passwords, API keys, tokens, secrets
- SSH private keys (unless encrypted with agenix)
- Database credentials, OAuth tokens, service account keys

**Personal Identifiable Information (PII)**:
- Email addresses (except in git config or documentation)
- Phone numbers, physical addresses (except location codes like WW87)
- Names of family members beyond initials

**Network Security Details**:
- Full IP addresses outside local ranges (192.168.x.x is OK)
- MAC addresses in plain text (only in encrypted .age files)
- VPN credentials, certificates, firewall rules exposing architecture

**Infrastructure Details**:
- Server root passwords, recovery keys, backup encryption passphrases
- Certificate private keys, webhook secrets

### âœ… What IS Safe to Commit

- **Encrypted Secrets**: `.age` files encrypted with agenix, files in `secrets/` directory, public SSH keys only
- **Configuration**: NixOS configurations (without secrets), public documentation, network topology (general structure)
- **Documentation**: Architecture diagrams, setup procedures, runbooks (without credentials), sanitized migration plans

### ğŸš¨ Before Every Commit

Always check:

1. **Review Changes**: `git diff` - scan for any secrets
2. **Check Staged Files**: `git status` - verify only intended files
3. **No Plain Text Secrets**: Search for patterns like `password =`, `token =`, `key =`
4. **Encrypted Only**: Ensure secrets are in `.age` files only
5. **Private Info**: Check for full names, emails, phone numbers

**High-Risk Files**: Any file with "secret", "password", "token" in name, files in `hosts/*/secrets/`, configuration files referencing credentials

### âŒ Examples of What NOT to Commit

```nix
# BAD - Plain text password
services.mysql.rootPassword = "SuperSecret123";

# BAD - API token
telegram.botToken = "1234567890:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX";
```

### âœ… Examples of What IS Safe to Commit

```nix
# GOOD - Reference to agenix secret
services.mysql.rootPasswordFile = config.age.secrets.mysql-root.path;

# GOOD - Encrypted file reference
telegram.botTokenFile = config.age.secrets.telegram-bot.path;
```

### âš ï¸ Special Cases

- **1Password References**: âœ… Safe - only vault IDs and item names, not actual secrets
- **Hostnames**: âœ… Safe - `miniserver99`, `csb0`, etc.
- **Local IPs**: âœ… Safe - `192.168.1.x` in config files
- **Location Codes**: âœ… Safe - `jhw22`, `ww87` (abstract, not full addresses)
- **User Initials**: âœ… Safe - `mba`, `mpe`, `gb` (not full names)

### ğŸš‘ If Secrets Are Committed (Emergency Response)

1. **STOP**: Do NOT push to remote
2. **Remove**: `git reset --soft HEAD~1` (before push)
3. **Rotate**: Change the exposed credential immediately
4. **Verify**: Check entire git history: `git log -p`
5. **If Pushed**: Assume secret is compromised, rotate immediately

### ğŸ¯ Remember

> **When in doubt, use agenix!**
>
> If it's a secret, password, token, or credential:
>
> 1. Encrypt it with agenix: `agenix -e secrets/name.age`
> 2. Reference it in config: `config.age.secrets.name.path`
> 3. Never commit plain text

### ğŸ”” AI Assistant Responsibility

Before suggesting any Git operation:

1. **Scan all staged changes** for security issues
2. **Warn user** if potential secrets detected
3. **Suggest agenix** for any credentials
4. **Block commit** if plain text secrets found
5. **Recommend review** for sensitive content

If you detect a potential secret during code generation or file editing:

- ğŸ›‘ **STOP** and alert the user immediately
- ğŸ”’ **Suggest** using agenix instead
- âŒ **DO NOT** proceed with the operation
- âœ… **WAIT** for user confirmation after sanitization
