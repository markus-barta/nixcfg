# OpenClaw Deployment on hsb1 - Session Pickup Document

**Date:** 2026-01-31  
**Session:** P9400 - HSB1: OpenClaw AI Assistant Deployment  
**Status:** Build Success, Service Startup Failed

---

## What Was Accomplished

### 1. NixOS Configuration Added

- **Package:** `pkgs/openclaw/default.nix` - Fetches pre-built npm package (v2026.1.29)
- **Flake:** Updated `flake.nix` with overlay for openclaw package
- **Service:** Systemd service `openclaw-gateway` defined in `hosts/hsb1/configuration.nix`
- **Secrets:** 3 agenix secrets created and configured:
  - `hsb1-openclaw-gateway-token.age`
  - `hsb1-openclaw-telegram-token.age`
  - `hsb1-openclaw-openrouter-key.age`

### 2. Configuration Files

- **secrets.nix:** Entries added for all 3 secrets
- **configuration.nix:**
  - `age.secrets` entries for decrypting secrets to `/run/agenix/`
  - `systemd.services.openclaw-gateway` service definition
  - `environment.systemPackages` includes openclaw

### 3. Host Configuration

- **openclaw.json:** Manually created at `/home/mba/.openclaw/openclaw.json`
  - Gateway binds to port 18789
  - References agenix secret paths
  - Configured for Telegram + OpenRouter (Kimi K2.5)

---

## Current Status

### ‚úÖ Working

- Package builds successfully from npm registry
- NixOS configuration activates without errors
- Binary installed: `/nix/store/.../bin/openclaw`
- Service unit created: `openclaw-gateway.service`

### ‚ùå Not Working

- **Service fails to start** - `systemctl status openclaw-gateway` shows failure
- Error during activation: "the following units failed: openclaw-gateway.service"

### üîÑ Next Steps

1. **Debug service failure:**

   ```bash
   ssh mba@hsb1.lan
   systemctl status openclaw-gateway
   journalctl -u openclaw-gateway -n 50
   ```

2. **Verify binary works:**

   ```bash
   # Test if openclaw binary runs
   /nix/store/*/bin/openclaw --version

   # Check if the entry point exists
   ls -la /nix/store/*/lib/openclaw/bin/
   ```

3. **Fix service configuration:**
   - Binary path may be wrong (currently: `$out/lib/openclaw/bin/openclaw.js`)
   - Check npm package structure for correct entry point
   - May need to adjust `ExecStart` in systemd service

---

## Technical Details

### Package Structure

```
pkgs/openclaw/default.nix
‚îú‚îÄ‚îÄ Fetches from: https://registry.npmjs.org/openclaw/-/openclaw-2026.1.29.tgz
‚îú‚îÄ‚îÄ Hash: sha256-5tiVpmjA86SC/4Ne3+28JgdCbsvgi2bA5HqV5f64Lmg=
‚îú‚îÄ‚îÄ Installs to: /nix/store/*/lib/openclaw/
‚îî‚îÄ‚îÄ Binary wrapper: /nix/store/*/bin/openclaw
```

### Service Configuration

```nix
systemd.services.openclaw-gateway = {
  description = "OpenClaw AI Assistant Gateway";
  serviceConfig = {
    User = "mba";
    Group = "users";
    WorkingDirectory = "/home/mba/.openclaw";
    ExecStart = "${pkgs.openclaw}/bin/openclaw gateway";
    Restart = "always";
  };
};
```

### Secrets Runtime Paths

- Gateway token: `/run/agenix/hsb1-openclaw-gateway-token`
- Telegram token: `/run/agenix/hsb1-openclaw-telegram-token`
- OpenRouter key: `/run/agenix/hsb1-openclaw-openrouter-key`

---

## Open Questions

1. **What is the actual service failure error?** (Need to check journalctl)
2. **Is the binary path correct?** (Check npm package structure)
3. **Do we need to run `openclaw onboard` first?** (Initial setup wizard)

---

## Commands to Run Next Session

### Debug Service

```bash
# On hsb1
systemctl status openclaw-gateway
journalctl -u openclaw-gateway -f

# Check binary
which openclaw
openclaw --help
openclaw gateway --help
```

### Manual Test

```bash
# Test gateway manually
sudo -u mba openclaw gateway --port 18789 --verbose
```

---

## References

- **Backlog Item:** `+pm/backlog/P9400-hsb1-openclaw-deployment.md`
- **OpenClaw Docs:** https://docs.openclaw.ai/
- **Host:** hsb1 (192.168.1.101)
- **Port:** 18789

---

## Notes for Next Session

The main blocker is the service failing to start. Most likely causes:

1. Binary path incorrect in wrapper script
2. Missing initial configuration (may need `openclaw onboard`)
3. Permission issues with agenix secrets

Start by checking `journalctl -u openclaw-gateway` to see the actual error.
