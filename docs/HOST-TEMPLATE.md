# Host Directory Template

Reference for setting up new hosts. Based on **hsb0** (home server) and **csb0** (cloud server).

---

## Required Structure

```
hosts/<hostname>/
‚îú‚îÄ‚îÄ configuration.nix           # Main NixOS config (hokage + uzumaki)
‚îú‚îÄ‚îÄ hardware-configuration.nix  # Auto-generated (nixos-generate-config)
‚îú‚îÄ‚îÄ disk-config.zfs.nix         # ZFS layout (if using ZFS)
‚îú‚îÄ‚îÄ README.md                   # Host overview + Quick Reference
‚îú‚îÄ‚îÄ ip-<address>.md             # IP marker file (see below)
‚îú‚îÄ‚îÄ runbook-secrets.age         # Encrypted secrets for Git (NOT consumed by NixOS!)
‚îÇ
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îî‚îÄ‚îÄ RUNBOOK.md              # Operational procedures (REQUIRED)
‚îÇ
‚îú‚îÄ‚îÄ secrets/
‚îÇ   ‚îî‚îÄ‚îÄ runbook-secrets.md      # Plain text credentials (gitignored, for local editing)
‚îÇ
‚îî‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ README.md               # Test overview
    ‚îî‚îÄ‚îÄ T00-nixos-base.sh       # Base system tests
```

---

## File Descriptions

### Configuration Files

| File                         | Purpose                                        | Required |
| ---------------------------- | ---------------------------------------------- | -------- |
| `configuration.nix`          | Main NixOS config with hokage/uzumaki settings | ‚úÖ Yes   |
| `hardware-configuration.nix` | Auto-generated by `nixos-generate-config`      | ‚úÖ Yes   |
| `disk-config.zfs.nix`        | Declarative ZFS disk layout (disko)            | If ZFS   |

### Documentation

| File              | Purpose                                | Required |
| ----------------- | -------------------------------------- | -------- |
| `README.md`       | Host overview, Quick Reference table   | ‚úÖ Yes   |
| `docs/RUNBOOK.md` | Operational procedures, recovery steps | ‚úÖ Yes   |
| `ip-<address>.md` | IP marker for quick identification     | ‚úÖ Yes   |

### Secrets & Tests

| File                         | Purpose                                          | Required |
| ---------------------------- | ------------------------------------------------ | -------- |
| `secrets/runbook-secrets.md` | Gitignored credentials reference (plain text)    | ‚úÖ Yes   |
| `runbook-secrets.age`        | Encrypted backup for Git (NOT consumed by NixOS) | ‚úÖ Yes   |
| `tests/README.md`            | Test documentation                               | ‚úÖ Yes   |
| `tests/T00-nixos-base.sh`    | Base system verification                         | ‚úÖ Yes   |

> ‚ö†Ô∏è **Important**: The `.age` file is purely for storing secrets in Git. NixOS does NOT consume it.
> Use `just decrypt-runbook-secrets <hostname>` to edit, then `just encrypt-runbook-secrets <hostname>` to save.

---

## IP Marker File

Create an empty file named after the IP address for quick identification:

```bash
# Home servers (last octet only)
touch hosts/hsb0/ip-99.md           # 192.168.1.99

# Cloud servers (full IP)
touch hosts/csb0/ip-85.235.65.226.md
```

**Why**: Instantly see IP addresses when listing directories.

---

## README.md Template

```markdown
# <hostname> - Short Description

**Status**: ‚úÖ Running | üîß Setup | ‚ùå Offline
**Type**: Home Server | Cloud Server | Desktop
**OS**: NixOS XX.XX
**Config**: External Hokage + Uzumaki modules

---

## Quick Reference

| Item         | Value                |
| ------------ | -------------------- |
| **Hostname** | `<hostname>`         |
| **IP (v4)**  | `<ip-address>`       |
| **SSH**      | `ssh mba@<hostname>` |
| **Location** | <physical location>  |

---

## Services

| Service | Port | Description   |
| ------- | ---- | ------------- |
| SSH     | 22   | Remote access |
| ...     | ...  | ...           |

---

## Folder Structure

[Copy from csb0/hsb0 and adapt]
```

---

## RUNBOOK.md Template

```markdown
# <hostname> Runbook

Operational procedures for <hostname>.

---

## Quick Commands

| Task         | Command                  |
| ------------ | ------------------------ |
| SSH access   | `ssh mba@<hostname>`     |
| Deploy       | `just <hostname>-switch` |
| Check status | `systemctl status`       |
| View logs    | `journalctl -f`          |

---

## Emergency Procedures

### Service Down

1. SSH into host
2. Check service: `systemctl status <service>`
3. View logs: `journalctl -u <service> -n 50`
4. Restart: `sudo systemctl restart <service>`

### Cannot SSH

1. Check network connectivity
2. Try IP directly: `ssh mba@<ip-address>`
3. Physical/VNC console access (see SECRETS.md)

### VNC Console Recovery (Cloud Servers)

[See csb0/csb1 runbooks for Netcup-specific procedures]

---

## Maintenance

### Updates

    cd ~/nixcfg && git pull
    just switch

### Rollback

    sudo nixos-rebuild switch --rollback
    # Or boot previous generation from GRUB
```

---

## runbook-secrets.md Template

> This file lives in `secrets/runbook-secrets.md` (gitignored). Encrypt to `runbook-secrets.age` for Git storage.
> The `.age` file is purely for backup ‚Äî NixOS does NOT consume it.

```markdown
# <hostname> - Complete Secrets Reference

**Host**: <hostname>
**Purpose**: <description>
**Last Updated**: <date>
**Encryption**: age (markus@barta.com key)

> ‚ö†Ô∏è **SENSITIVE** - This file contains ALL credentials for <hostname>.
> Keep in gitignored `secrets/` folder or encrypted as `runbook-secrets.age`.

---

## üîë SSH Access

| Item           | Value           |
| -------------- | --------------- |
| **Hostname**   | `<hostname>`    |
| **IP Address** | `<ip>`          |
| **Username**   | `mba`           |
| **Port**       | `22`            |
| **SSH Key**    | `~/.ssh/id_rsa` |
| **Sudo**       | Passwordless ‚úÖ |

---

## üñ•Ô∏è Physical/Console Access

| Item                  | Value                     |
| --------------------- | ------------------------- |
| **Console Password**  | `_______________`         |
| **VNC URL**           | (Netcup SCP panel)        |
| **Recovery Password** | 1Password: `<entry-name>` |

---

## üåê Services

| Service  | URL        | Username | Password          |
| -------- | ---------- | -------- | ----------------- |
| Service1 | http://... | `admin`  | `_______________` |

---

## üìã 1Password References

| Service | 1Password Entry |
| ------- | --------------- |
| SSH Key | `<entry>`       |
| Console | `<entry>`       |

---

**Last Verified**: <date>
```

---

## tests/README.md Template

```markdown
# <hostname> Tests

Test procedures for verifying <hostname> functionality.

## Running Tests

    # Run all tests
    ./run-all-tests.sh

    # Run specific test
    ./T01-<service>.sh

## Test Index

| Test | Description       | Script              |
| ---- | ----------------- | ------------------- |
| T00  | NixOS Base System | `T00-nixos-base.sh` |
| T01  | <Service 1>       | `T01-<service>.sh`  |
```

---

## Checklist for New Host

- [ ] Create directory: `mkdir -p hosts/<hostname>/{docs,secrets,tests}`
- [ ] Add `configuration.nix` with hokage/uzumaki settings
- [ ] Add `hardware-configuration.nix` from target machine
- [ ] Add `disk-config.zfs.nix` (if ZFS)
- [ ] Create `README.md` with Quick Reference
- [ ] Create `docs/RUNBOOK.md`
- [ ] Create `secrets/runbook-secrets.md` (populate credentials locally)
- [ ] Encrypt: `just encrypt-runbook-secrets <hostname>` ‚Üí creates `runbook-secrets.age`
- [ ] Create IP marker: `touch ip-<address>.md`
- [ ] Create `tests/README.md`
- [ ] Create `tests/T00-nixos-base.sh`
- [ ] Add to `flake.nix`
- [ ] Add host key to `secrets/secrets.nix`
- [ ] Run `just rekey` if host needs secret access
