# StaSysMo - Starship System Monitoring

System metrics (CPU, RAM, Load, Swap) displayed in your Starship prompt with threshold-based coloring.

## Overview

StaSysMo consists of:

- **Daemon**: Background service sampling metrics every 5 seconds
- **Reader**: Starship custom module displaying formatted metrics
- **Config**: Centralized configuration (no magic numbers!)

```text
┌──────────────────────────────────────────────────────────────────┐
│  daemon (systemd/launchd) → /dev/shm/stasysmo/ or /tmp/stasysmo/ │
│                                    ↓                             │
│                            reader (starship)                     │
│                                    ↓                             │
│              Prompt: C 5% M 52% L 1.2 S 2%                       │
│                      (icons render as Nerd Font glyphs)          │
└──────────────────────────────────────────────────────────────────┘
```

## Metrics Explained

| Metric   | Icon | What it shows  | How it's measured                                                                                                                                 |
| -------- | ---- | -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| **CPU**  | C    | CPU usage %    | **Linux**: Delta of `/proc/stat` between samples (accurate over interval). **macOS**: Sum of all process CPU% via `ps`, normalized by core count. |
| **RAM**  | M    | Memory usage % | **Linux**: `(MemTotal - MemAvailable) / MemTotal` from `/proc/meminfo`. **macOS**: `(active + wired + speculative pages) / total` via `vm_stat`.  |
| **Load** | L    | 1-min load avg | **Linux**: First field of `/proc/loadavg`. **macOS**: `sysctl vm.loadavg`. Represents average runnable processes.                                 |
| **Swap** | S    | Swap usage %   | **Linux**: `(SwapTotal - SwapFree) / SwapTotal` from `/proc/meminfo`. **macOS**: `used / total` from `sysctl vm.swapusage`. Hidden if 0%.         |

### Update Interval & Accuracy

- **Default interval**: 5 seconds (configurable via `daemon.interval`)
- **CPU%**: Calculated as delta between samples, so accuracy improves with interval
- **RAM/Swap/Load**: Point-in-time snapshots, no delta needed
- **Staleness**: If data is older than `staleThreshold` (default 10s), shows `?`

## Files

| File               | Purpose                                 |
| ------------------ | --------------------------------------- |
| `config.nix`       | Centralized configuration defaults      |
| `daemon.sh`        | Background daemon (Linux + macOS)       |
| `reader.sh`        | Starship custom module                  |
| `icons.sh`         | Nerd Font icons (generated by Python)   |
| `nixos.nix`        | NixOS module (systemd)                  |
| `home-manager.nix` | Home Manager module (launchd for macOS) |

## Usage

### NixOS

```nix
# In configuration.nix
imports = [ ../../modules/shared/stasysmo/nixos.nix ];

services.stasysmo.enable = true;
```

### macOS (Home Manager)

```nix
# In home.nix
imports = [ ../../modules/shared/stasysmo/home-manager.nix ];

services.stasysmo.enable = true;
```

## Configuration

All settings are in `config.nix`. Override via module options:

```nix
services.stasysmo = {
  enable = true;

  # Daemon
  daemon.interval = 5000;  # Sampling interval in ms

  # Display
  display = {
    maxBudget = 45;           # Max characters for metrics
    minTerminalWidth = 0;     # Hide if terminal narrower (0 = always show)
    staleThreshold = 10;      # Seconds before data is "stale"
    spacerIconValue = "";     # Between icon and value (e.g., "C5%" vs "C 5%")
    spacerMetrics = " ";      # Between metrics (e.g., "5% 52%" vs "5%  52%")
  };

  # Thresholds (trigger color changes)
  metrics.cpu.thresholds = { elevated = 50; critical = 80; };
  metrics.ram.thresholds = { elevated = 70; critical = 90; };
  metrics.load.thresholds = { elevated = 2.0; critical = 4.0; };
  metrics.swap.thresholds = { elevated = 10; critical = 50; };

  # Colors (ANSI 256)
  colors.muted = 242;     # Gray - normal state
  colors.elevated = 255;  # White - noticeable
  colors.critical = 196;  # Red - urgent
};
```

### Using Presets

`config.nix` provides predefined constants so you don't have to type Unicode or remember magic numbers:

```nix
let
  stasysmo = import ../../modules/shared/stasysmo/config.nix;
in {
  services.stasysmo = {
    enable = true;

    # Use preset intervals instead of raw milliseconds
    daemon.interval = stasysmo.presets.interval.fast;  # 2000ms

    display = {
      # Use preset budgets
      maxBudget = stasysmo.presets.budget.compact;     # 30 chars

      # Use preset spacers (includes Unicode characters)
      spacerIconValue = stasysmo.presets.spacer.thin;  # U+2009 thin space
      spacerMetrics = stasysmo.presets.spacer.dot;     # " . " with bullet
    };
  };
}
```

### Available Presets

| Category     | Preset      | Value  | Description                |
| ------------ | ----------- | ------ | -------------------------- |
| **spacer**   | `none`      | `""`   | No space                   |
|              | `hair`      | U+200A | Hair space (thinnest)      |
|              | `thin`      | U+2009 | Thin space                 |
|              | `narrow`    | U+202F | Narrow no-break space      |
|              | `normal`    | ` `    | Regular ASCII space        |
|              | `en`        | U+2002 | En space (half em)         |
|              | `em`        | U+2003 | Em space (full width)      |
|              | `double`    | `  `   | Two regular spaces         |
|              | `pipe`      | `\|`   | Box drawing pipe separator |
|              | `dot`       | `.`    | Bullet separator (U+2022)  |
|              | `diamond`   | `X`    | Diamond separator (U+25C6) |
|              | `bar`       | `\|`   | ASCII pipe separator       |
| **interval** | `realtime`  | 500    | 0.5s - very responsive     |
|              | `fast`      | 1000   | 1s - responsive            |
|              | `normal`    | 2500   | 2.5s - balanced            |
|              | `relaxed`   | 5000   | 5s - low overhead          |
|              | `lazy`      | 10000  | 10s - minimal              |
| **budget**   | `minimal`   | 20     | Just CPU+RAM               |
|              | `compact`   | 30     | CPU, RAM, Load             |
|              | `normal`    | 45     | All metrics                |
|              | `wide`      | 60     | Generous spacing           |
|              | `unlimited` | 200    | No limit                   |
| **stale**    | `strict`    | 5      | Mark stale quickly         |
|              | `normal`    | 10     | Default                    |
|              | `tolerant`  | 20     | More forgiving             |
|              | `relaxed`   | 60     | Very tolerant              |

### Threshold Behavior

| State        | Color | When                           |
| ------------ | ----- | ------------------------------ |
| **Muted**    | Gray  | Value below elevated threshold |
| **Elevated** | White | Value ≥ elevated, < critical   |
| **Critical** | Red   | Value ≥ critical threshold     |

## Icons

Icons are Nerd Font glyphs stored in `icons.sh`. In the terminal with a Nerd Font, they render as graphical icons. In editors without Nerd Fonts, they may appear as `?` or boxes.

| Metric | Text | Nerd Font Code | Glyph Name                    |
| ------ | ---- | -------------- | ----------------------------- |
| CPU    | C    | `\uf4bc`       | nf-oct-cpu                    |
| RAM    | M    | `\uefc5`       | nf-md-memory                  |
| Load   | L    | `\U000f029a`   | nf-md-pulse                   |
| Swap   | S    | `\U000f0fb4`   | nf-md-swap_horizontal_variant |

### Regenerating Icons

Icons are generated by Python to preserve Unicode (Nix/shell can corrupt them):

```bash
python3 << 'PYTHON'
icons = {
    'CPU_ICON': '\uf4bc',
    'RAM_ICON': '\uefc5',
    'LOAD_ICON': '\U000f029a',
    'SWAP_ICON': '\U000f0fb4',
}
with open('icons.sh', 'w') as f:
    f.write('# Generated by Python - DO NOT EDIT MANUALLY\n')
    for name, char in icons.items():
        f.write(f'{name}="{char}"\n')
PYTHON
```

**⚠️ DO NOT edit icons.sh manually** - always regenerate with Python.

## Starship Integration

StaSysMo adds a custom module to `starship-template.toml`:

```toml
[custom.stasysmo]
command = "stasysmo-reader"
when = "test -f /dev/shm/stasysmo/timestamp || test -f /tmp/stasysmo/timestamp"
format = "[$output ]($style)"
style = ""
```

## Platform Support

| Platform | Daemon          | Output Directory     |
| -------- | --------------- | -------------------- |
| NixOS    | systemd service | `/dev/shm/stasysmo/` |
| macOS    | launchd agent   | `/tmp/stasysmo/`     |

## Testing

See `tests/` directory for automated and manual tests.

```bash
# Run all tests
cd tests
./run-all.sh

# Run specific test
./T01-daemon.sh
```

## Troubleshooting

### Metrics not showing

1. Check daemon is running:
   - NixOS: `systemctl status stasysmo-daemon`
   - macOS: `launchctl list | grep stasysmo`

2. Check output files exist:

   ```bash
   ls -la /dev/shm/stasysmo/  # Linux
   ls -la /tmp/stasysmo/      # macOS
   ```

3. Check for errors:
   - macOS: `cat /tmp/stasysmo-daemon.error.log`

### Icons not displaying

1. Ensure Nerd Font is installed
2. Check terminal supports Unicode
3. Verify icons.sh has correct characters:
   ```bash
   cat icons.sh | od -c | head -20
   ```

---

## Development Notes

Technical reference for continuing development. Documents design decisions, pitfalls, and solutions discovered during initial implementation.

### Architecture Decisions

| Decision                             | Rationale                                                                         |
| ------------------------------------ | --------------------------------------------------------------------------------- |
| Daemon + reader separation           | CPU% requires delta calculation; pre-compute in daemon, instant read in prompt    |
| RAM-backed files (`/dev/shm`)        | Zero I/O latency; macOS falls back to `/tmp` (SSD, acceptable)                    |
| Fixed budget (45 chars)              | Decouples reader from prompt layout; simpler than dynamic width                   |
| Platform-specific Nix modules        | `nixos.nix` (systemd) vs `home-manager.nix` (launchd) - cleaner than conditionals |
| Python-generated `icons.sh`          | Only reliable way to preserve Unicode through Nix evaluation and shell sourcing   |
| Placeholder substitution in template | `__PL_LEFT_SOFT__` → `` prevents Unicode corruption during text edits             |

### Terminal Width Detection

**Problem**: Starship custom modules run in subprocesses where `$COLUMNS` is unset and `tput cols` returns default (80).

**Solution**: Use `/dev/tty` to query the controlling terminal directly:

```bash
width=$(stty size < /dev/tty 2>/dev/null | awk '{print $2}') || \
width=$(tput cols < /dev/tty 2>/dev/null) || \
width=80
```

**Why it works**: Even in a subprocess with piped stdin/stdout, `/dev/tty` always refers to the controlling terminal of the session.

### ANSI Color Preservation

**Problem**: `\033[0m` (full reset) clears Starship's background color, breaking powerline segment transitions.

**Solution**: Use `\033[39m` (reset foreground only) to preserve the `bg:` style set by Starship:

```bash
ansi_reset() { printf '\033[39m'; }  # NOT \033[0m
```

### Powerline Character Handling

**Problem**: Nerd Font glyphs (`, `) are corrupted when editing `starship-template.toml` in editors without Nerd Font support.

**Solution**: Use ASCII placeholders in template, substitute in `theme-hm.nix`:

```nix
# starship-template.toml
format = "[__PL_LEFT_SOFT__](fg:__DARKEST__)"

# theme-hm.nix (builtins.replaceStrings)
"__PL_LEFT_SOFT__" → ""  # U+E0B6
```

Placeholders: `__PL_LEFT_HARD__` (), `__PL_RIGHT_HARD__` (), `__PL_LEFT_SOFT__` (), `__PL_RIGHT_SOFT__` ()

### macOS-Specific Issues

| Issue                     | Solution                                                           |
| ------------------------- | ------------------------------------------------------------------ |
| `bash 3.2` (no `mapfile`) | Use `while IFS= read -r` loop instead                              |
| `vm_stat` output format   | `grep -oE '[0-9]+\.'` (no `$` anchor - trailing whitespace varies) |
| Swap thresholds           | macOS pre-swaps aggressively; use 50%/75% vs Linux 33%/66%         |
| `$COLUMNS` unset          | Detect via `stty size < /dev/tty`                                  |

### Bash Arithmetic Pitfalls

**Problem**: `((metric_count++))` exits with code 1 when `metric_count=0`, triggering `set -e`.

**Solution**: Use explicit assignment:

```bash
metric_count=$((metric_count + 1))  # NOT ((metric_count++))
```

### Variable Expansion for Empty Strings

**Problem**: `${VAR:-default}` uses default if VAR is unset OR empty. Can't pass empty string as spacer.

**Solution**: Use `${VAR-default}` (no colon) - uses default only if unset:

```bash
spacer="${SPACER_ICON_VALUE-}"  # Allows empty string
```

### Starship Format String Syntax

Segment format with background color transitions:

```toml
# Rounded left cap (transition into segment)
[__PL_LEFT_SOFT__](fg:__DARKEST__)

# Segment content with background
[ $output ](fg:__TEXT_MUTED__ bg:__DARKEST__)

# Transition to next segment (different bg)
[__PL_LEFT_SOFT__](fg:__DARKER__ bg:__DARKEST__)
```

Key insight: The cap character's foreground must match the segment's background; the cap's background must match the previous segment's background (or none for first segment).

### Progressive Hiding

Terminal width thresholds for metric visibility:

| Width   | Behavior                |
| ------- | ----------------------- |
| < 60    | Hide all (no artifacts) |
| 60-79   | Show 1 metric (CPU)     |
| 80-99   | Show 2 metrics          |
| 100-129 | Show 3 metrics          |
| ≥ 130   | Show all 4 metrics      |

**Artifact prevention**: Only emit output if at least one metric will be shown:

```bash
[[ -z "$output" ]] && exit 0  # No output = no segment
```

### Debug Mode

Set `STASYSMO_DEBUG=1` in Nix config for runtime diagnostics. Only displays in interactive TTY (not in Starship subprocess):

```
┌─ StaSysMo Debug ─────────────────────────────────
│ WIDTH: tput=156 COLUMNS=unset → using 156
│ SLOTS: hideAll=60 show1=80 ... → max_metrics=4
│ STALE: timestamp=... now=... age=1s threshold=10s
│ DATA: cpu=6% ram=51% load=7.47 swap=59%
│ OUTPUT: metrics_shown=4 visible_chars=36 budget=45
└──────────────────────────────────────────────────
```

### Known Issues (Backlog)

1. **Trailing space after `nix_shell` segment**: A single space appears after the `)` powerline cap. Source not yet identified in Starship format strings. See enhancements backlog.

### Testing Strategy

Automated tests (`tests/run-all.sh`) cover:

- Platform detection
- Daemon file creation
- Output file format
- Reader output format
- Width threshold behavior

Manual verification required for:

- Visual powerline transitions
- Color rendering
- Nerd Font icon display
- Real terminal width responsiveness
