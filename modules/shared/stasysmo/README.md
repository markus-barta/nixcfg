# StaSysMo - Starship System Monitoring

System metrics (CPU, RAM, Load, Swap) displayed in your Starship prompt with threshold-based coloring.

## Overview

StaSysMo consists of:

- **Daemon**: Background service sampling metrics every 5 seconds
- **Reader**: Starship custom module displaying formatted metrics
- **Config**: Centralized configuration (no magic numbers!)

```
┌─────────────────────────────────────────────────────────────────┐
│  daemon (systemd/launchd) → /dev/shm/stasysmo/ or /tmp/stasysmo/│
│                                    ↓                            │
│                            reader (starship)                    │
│                                    ↓                            │
│                   Prompt:  5%  52% 󰊚 1.2 󰾴 2%                 │
└─────────────────────────────────────────────────────────────────┘
```

## Files

| File               | Purpose                                 |
| ------------------ | --------------------------------------- |
| `config.nix`       | Centralized configuration defaults      |
| `daemon.sh`        | Background daemon (Linux + macOS)       |
| `reader.sh`        | Starship custom module                  |
| `icons.sh`         | Nerd Font icons (generated by Python)   |
| `nixos.nix`        | NixOS module (systemd)                  |
| `home-manager.nix` | Home Manager module (launchd for macOS) |

## Usage

### NixOS

```nix
# In configuration.nix
imports = [ ../../modules/shared/stasysmo/nixos.nix ];

services.stasysmo.enable = true;
```

### macOS (Home Manager)

```nix
# In home.nix
imports = [ ../../modules/shared/stasysmo/home-manager.nix ];

services.stasysmo.enable = true;
```

## Configuration

All settings are in `config.nix`. Override via module options:

```nix
services.stasysmo = {
  enable = true;

  # Daemon
  daemon.interval = 5000;  # ms

  # Display
  display.maxBudget = 45;
  display.minTerminalWidth = 100;
  display.staleThreshold = 10;

  # Thresholds
  metrics.cpu.thresholds.elevated = 50;
  metrics.cpu.thresholds.critical = 80;
  metrics.ram.thresholds.elevated = 70;
  metrics.ram.thresholds.critical = 90;
  metrics.load.thresholds.elevated = 2.0;
  metrics.load.thresholds.critical = 4.0;
  metrics.swap.thresholds.elevated = 10;
  metrics.swap.thresholds.critical = 50;

  # Colors (ANSI 256)
  colors.muted = 242;     # Gray
  colors.elevated = 255;  # White
  colors.critical = 196;  # Red
};
```

## Icons

Icons are stored in `icons.sh`, generated by Python to preserve Unicode:

```bash
# To regenerate icons
python3 << 'PYTHON'
icons = {
    'cpu': '\uf4bc',      # nf-oct-cpu
    'ram': '\uefc5',      # nf-md-memory
    'load': '\U000f029a', # nf-md-pulse
    'swap': '\U000f0fb4', # nf-md-swap_horizontal_variant
}
# ... see icons.sh for full script
PYTHON
```

**DO NOT edit icons.sh manually** - use Python to regenerate.

## Starship Integration

StaSysMo adds a custom module to `starship-template.toml`:

```toml
[custom.stasysmo]
command = "stasysmo-reader"
when = "test -f /dev/shm/stasysmo/timestamp || test -f /tmp/stasysmo/timestamp"
format = "[$output ]($style)"
style = ""
```

## Platform Support

| Platform | Daemon          | Output Directory     |
| -------- | --------------- | -------------------- |
| NixOS    | systemd service | `/dev/shm/stasysmo/` |
| macOS    | launchd agent   | `/tmp/stasysmo/`     |

## Testing

See `tests/` directory for automated and manual tests.

```bash
# Run all tests
cd tests
./run-all.sh

# Run specific test
./T01-daemon.sh
```

## Troubleshooting

### Metrics not showing

1. Check daemon is running:
   - NixOS: `systemctl status stasysmo-daemon`
   - macOS: `launchctl list | grep stasysmo`

2. Check output files exist:

   ```bash
   ls -la /dev/shm/stasysmo/  # Linux
   ls -la /tmp/stasysmo/      # macOS
   ```

3. Check for errors:
   - macOS: `cat /tmp/stasysmo-daemon.error.log`

### Icons not displaying

1. Ensure Nerd Font is installed
2. Check terminal supports Unicode
3. Verify icons.sh has correct characters:
   ```bash
   cat icons.sh | od -c | head -20
   ```
