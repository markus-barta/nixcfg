# Shared Modules

This directory contains configuration files shared across all systems (NixOS servers and macOS workstations).

## Files

| File               | Purpose                                                  | Used By                        |
| ------------------ | -------------------------------------------------------- | ------------------------------ |
| `fish-config.nix`  | Fish shell aliases, abbreviations, `sourcefish` function | `common.nix`, `imac0/home.nix` |
| `macos-common.nix` | macOS-specific: WezTerm, fonts, packages                 | `imac0`, `imac-mba-work`       |
| `starship.toml`    | Tokyo Night prompt theme                                 | All systems                    |

---

## starship.toml

### ⚠️ CRITICAL: Editing Rules

**DO NOT edit this file with heredocs, echo, or manual typing of Unicode characters!**

The file contains Nerd Font Unicode glyphs that get corrupted easily.

### ✅ Safe Ways to Edit

1. **Use the official preset as base:**

   ```bash
   starship preset tokyo-night -o ~/.config/starship.toml
   ```

2. **Make surgical edits with sed (simple values only):**

   ```bash
   sed -i '' 's/truncation_length = 3/truncation_length = 0/' ~/.config/starship.toml
   ```

3. **Use Python for Unicode-safe edits:**

   ```python
   with open('starship.toml', 'r') as f:
       content = f.read()
   content = content.replace('old', 'new')
   with open('starship.toml', 'w') as f:
       f.write(content)
   ```

4. **Add new sections by appending (with Python for symbols):**
   ```python
   new_section = '''
   [python]
   symbol = "\ue73c"
   '''
   content += new_section
   ```

### ❌ DO NOT

- Use `cat << 'EOF'` heredocs (corrupts Unicode)
- Manually type Nerd Font icons (they won't render correctly)
- Copy/paste from web browsers (encoding issues)
- Use `echo` to write the file

### Features

| Feature         | Description                                       |
| --------------- | ------------------------------------------------- |
| Dynamic OS icon | Shows on Mac, on NixOS, on Linux                  |
| Full path       | No truncation, always shows complete path         |
| Git info        | Branch, status, commit count (#2329)              |
| Languages       | Node.js, Python, Rust, Go, PHP                    |
| Docker          | Shows context when in Docker project              |
| Time            | **Always right-aligned**, with seconds (19:14:20) |
| Nix shell       | Subtle segment after time (❄ impure/pure)        |

### Layout

```
Left side                              $fill                    Right side
░▒▓ [OS] [path] [git] [langs]  ←────────────────────→  [time] [❄ nix]
#a3aed2  #769ff0 #394260 #212736                         #1d2230  #13161f
brightest ────────────────────────────────────────────────────► darkest
```

- Uses `$fill` to push time to the right edge
- Nix shell is a subtle, darker segment (muted gray text `#5a6070`)

### Prerequisites

- **Nerd Font** installed (Hack Nerd Font Mono recommended)
- **WezTerm** configured to use the Nerd Font
- No conflicting plain Hack fonts in `~/Library/Fonts/`

### Testing Icons

```bash
python3 -c "
icons = [
    ('\ue0b0', 'Powerline arrow'),
    ('\uf179', 'Apple'),
    ('\uf313', 'NixOS'),
    ('\ue725', 'Git branch'),
    ('\ue73c', 'Python'),
]
for char, name in icons:
    print(f'{char} = {name}')
"
```

---

## fish-config.nix

Provides:

- `sourcefish` function - Load .env files into fish session
- `EDITOR=nano` - Default editor
- Common aliases and abbreviations

Used via `programs.fish.interactiveShellInit` in `common.nix`.

---

## macos-common.nix

Provides:

- WezTerm configuration (Tokyo Night theme, Hack Nerd Font)
- Font installation activation script
- Common macOS packages
- Nano configuration

Used by macOS Home Manager configurations.
