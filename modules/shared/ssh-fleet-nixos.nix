# SSH Fleet Config for NixOS (system-level)
# Manages /etc/ssh/ssh_config
{ ... }:
{
  # NixOS: Configure system-wide SSH client via /etc/ssh/ssh_config
  programs.ssh.extraConfig = ''
    # Fleet SSH Configuration - Auto LANâ†’Tailscale fallback
    # Generated by modules/shared/ssh-fleet-nixos.nix

    # Keep-alive disabled (prevents drops during long ops like nixos-rebuild)
    # ServerAliveInterval 0 is the default - omitted

    # NOTE: No GitHub/Git SSH keys here!
    # Each host has its own keys. Per-host Git SSH config belongs in
    # the host's configuration.nix or user SSH config (~/.ssh/config).

    Host traefik.barta.cm
      HostName traefik.barta.cm
      User mba

    # === HOME NETWORK HOSTS ===
    Host hsb0
      HostName 192.168.1.99
      User mba
      ProxyCommand sh -c 'if nc -z -w2 %h %p 2>/dev/null; then nc %h %p; else nc hsb0.ts.barta.cm %p; fi'

    Host hsb0-lan
      HostName 192.168.1.99
      User mba

    Host hsb0-ts
      HostName hsb0.ts.barta.cm
      User mba

    Host hsb1
      HostName 192.168.1.101
      User mba
      ProxyCommand sh -c 'if nc -z -w2 %h %p 2>/dev/null; then nc %h %p; else nc hsb1.ts.barta.cm %p; fi'

    Host hsb1-lan
      HostName 192.168.1.101
      User mba

    Host hsb1-ts
      HostName hsb1.ts.barta.cm
      User mba

    Host hsb2
      HostName 192.168.1.95
      User mba
      ProxyCommand sh -c 'if nc -z -w2 %h %p 2>/dev/null; then nc %h %p; else nc hsb2.ts.barta.cm %p; fi'

    Host hsb2-lan
      HostName 192.168.1.95
      User mba

    Host hsb2-ts
      HostName hsb2.ts.barta.cm
      User mba

    Host hsb8
      HostName 192.168.1.100
      User mba
      ProxyCommand sh -c 'if nc -z -w2 %h %p 2>/dev/null; then nc %h %p; else nc hsb8.ts.barta.cm %p; fi'

    Host hsb8-lan
      HostName 192.168.1.100
      User mba

    Host hsb8-ts
      HostName hsb8.ts.barta.cm
      User mba

    Host gpc0
      HostName 192.168.1.154
      User mba
      ProxyCommand sh -c 'if nc -z -w2 %h %p 2>/dev/null; then nc %h %p; else nc gpc0.ts.barta.cm %p; fi'

    Host gpc0-lan
      HostName 192.168.1.154
      User mba

    Host gpc0-ts
      HostName gpc0.ts.barta.cm
      User mba

    Host imac0
      HostName 192.168.1.150
      User markus
      ProxyCommand sh -c 'if nc -z -w2 %h %p 2>/dev/null; then nc %h %p; else nc imac0.ts.barta.cm %p; fi'

    Host imac0-lan
      HostName 192.168.1.150
      User markus

    Host imac0-ts
      HostName imac0.ts.barta.cm
      User markus

    # === PORTABLE/WORK HOSTS ===
    Host mba-mbp-work
      HostName 192.168.1.197
      User mba
      ProxyCommand sh -c 'if nc -z -w2 %h %p 2>/dev/null; then nc %h %p; else nc mba-mbp-work.ts.barta.cm %p; fi'

    Host mba-mbp-work-lan
      HostName 192.168.1.197
      User mba

    Host mba-mbp-work-ts
      HostName mba-mbp-work.ts.barta.cm
      User mba

    Host mbpw
      HostName mba-mbp-work

    Host mbpw-lan
      HostName 192.168.1.197
      User mba

    Host mbpw-ts
      HostName mba-mbp-work.ts.barta.cm
      User mba

    Host mba-imac-work
      HostName 10.17.1.7
      User markus
      ProxyCommand sh -c 'if nc -z -w2 %h %p 2>/dev/null; then nc %h %p; else nc mba-imac-work.ts.barta.cm %p; fi'

    Host mba-imac-work-lan
      HostName 10.17.1.7
      User markus

    Host mba-imac-work-ts
      HostName mba-imac-work.ts.barta.cm
      User markus

    Host imacw
      HostName mba-imac-work

    Host imacw-lan
      HostName 10.17.1.7
      User markus

    Host imacw-ts
      HostName mba-imac-work.ts.barta.cm
      User markus

    Host miniserver-bp
      HostName 10.17.1.40
      Port 2222
      User mba
      ProxyCommand sh -c 'if nc -z -w2 %h %p 2>/dev/null; then nc %h %p; else nc miniserver-bp.ts.barta.cm %p; fi'

    Host miniserver-bp-lan
      HostName 10.17.1.40
      Port 2222
      User mba

    Host miniserver-bp-ts
      HostName miniserver-bp.ts.barta.cm
      Port 2222
      User mba

    Host msbp
      HostName miniserver-bp.ts.barta.cm
      Port 2222
      User mba

    Host msbp-lan
      HostName 10.17.1.40
      Port 2222
      User mba

    Host msbp-ts
      HostName miniserver-bp.ts.barta.cm
      Port 2222
      User mba

    # === CLOUD HOSTS ===
    Host csb0
      HostName csb0.ts.barta.cm
      User mba
      Port 2222

    Host csb0-ts
      HostName csb0.ts.barta.cm
      User mba
      Port 2222

    Host csb1
      HostName csb1.ts.barta.cm
      User mba
      Port 2222

    Host csb1-ts
      HostName csb1.ts.barta.cm
      User mba
      Port 2222
  '';
}
