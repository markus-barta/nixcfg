---
description: Prevent security-critical data from being committed to Git
globs: "**/*"
alwaysApply: true
---

# Security & Git Commit Policy

## ğŸ”’ CRITICAL RULE: Never Commit Security-Critical Data

**NEVER** commit, stage, or include in Git operations any of the following:

### â›” Absolutely Forbidden

**Passwords & Credentials**:

- Plain text passwords
- API keys, tokens, or secrets
- SSH private keys (unless encrypted with agenix)
- Database credentials
- OAuth tokens or client secrets
- Service account keys

**Personal Identifiable Information (PII)**:

- Email addresses (except in git config or documentation)
- Phone numbers
- Physical addresses (except general location codes like WW87)
- Names of family members beyond initials

**Network Security Details**:

- Full IP addresses outside of local ranges (192.168.x.x is OK in configs)
- MAC addresses in plain text (only in encrypted .age files)
- VPN credentials or certificates
- Firewall rules exposing internal architecture

**Infrastructure Details**:

- Server root passwords
- Recovery keys
- Backup encryption passphrases
- Certificate private keys
- Webhook secrets

## âœ… What IS Safe to Commit

**Encrypted Secrets**:

- `.age` files encrypted with agenix
- Files in `secrets/` directory (already encrypted)
- Public SSH keys only

**Configuration**:

- NixOS configurations (without secrets)
- Public documentation
- Network topology (general structure, not credentials)
- Service configurations using secret placeholders

**Documentation**:

- Architecture diagrams
- Setup procedures
- Runbooks (without credentials)
- Migration plans (sanitized)

## ğŸš¨ Before Every Commit

Always check:

1. **Review Changes**: `git diff` - scan for any secrets
2. **Check Staged Files**: `git status` - verify only intended files
3. **No Plain Text Secrets**: Search for patterns like `password =`, `token =`, `key =`
4. **Encrypted Only**: Ensure secrets are in `.age` files only
5. **Private Info**: Check for full names, emails, phone numbers

## ğŸ” High-Risk Files to Review Carefully

- Any file with "secret", "password", "token" in the name
- Files in `hosts/*/secrets/` directories
- Configuration files referencing credentials
- Documentation with examples (sanitize before commit)
- Scripts that might contain hardcoded values
- Backup or export files

## âŒ Examples of What NOT to Commit

```nix
# BAD - Plain text password
services.mysql.rootPassword = "SuperSecret123";

# BAD - API token
telegram.botToken = "7010071349:AAF3B_q7vLQGKOTDJsbSKAnvXFYpOa5Mnsg";

# BAD - SSH private key
ssh.privateKey = "-----BEGIN OPENSSH PRIVATE KEY-----\n...";
```

## âœ… Examples of What IS Safe to Commit

```nix
# GOOD - Reference to agenix secret
services.mysql.rootPasswordFile = config.age.secrets.mysql-root.path;

# GOOD - Encrypted file reference
telegram.botTokenFile = config.age.secrets.telegram-bot.path;

# GOOD - Public key
ssh.publicKey = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5...";
```

## ğŸ›¡ï¸ Repository Security Levels

### Private Repository

- Can contain encrypted secrets (.age files)
- Can reference internal infrastructure
- Can include detailed network topology
- Still NO plain text credentials ever

### Public Repository

- Must sanitize all internal references
- Must use placeholders for all secrets
- Must redact server IPs (except local ranges)
- Must be audit-ready at all times

## ğŸš‘ If Secrets Are Committed (Emergency Response)

1. **STOP**: Do NOT push to remote
2. **Remove**: `git reset --soft HEAD~1` (before push)
3. **Rotate**: Change the exposed credential immediately
4. **Verify**: Check entire git history: `git log -p`
5. **If Pushed**: Assume secret is compromised, rotate immediately

## âš ï¸ Special Cases

**1Password References**: âœ… Safe - only vault IDs and item names, not actual secrets

**Hostnames**: âœ… Safe - `miniserver99`, `csb0`, etc.

**Local IPs**: âœ… Safe - `192.168.1.x` in config files

**Location Codes**: âœ… Safe - `jhw22`, `ww87` (abstract, not full addresses)

**User Initials**: âœ… Safe - `mba`, `mpe`, `gb` (not full names)

## ğŸ¯ Remember

> **When in doubt, use agenix!**
>
> If it's a secret, password, token, or credential:
>
> 1. Encrypt it with agenix: `agenix -e secrets/name.age`
> 2. Reference it in config: `config.age.secrets.name.path`
> 3. Never commit plain text

## ğŸ”” AI Assistant Responsibility

Before suggesting any Git operation:

1. **Scan all staged changes** for security issues
2. **Warn user** if potential secrets detected
3. **Suggest agenix** for any credentials
4. **Block commit** if plain text secrets found
5. **Recommend review** for sensitive content

If you detect a potential secret during code generation or file editing:

- ğŸ›‘ **STOP** and alert the user immediately
- ğŸ”’ **Suggest** using agenix instead
- âŒ **DO NOT** proceed with the operation
- âœ… **WAIT** for user confirmation after sanitization
