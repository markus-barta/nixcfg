# Hostname Audit: `miniserver24` References

**Audit Date**: 2025-11-28  
**Purpose**: Identify all `miniserver24` hostname references before migration to `hsb1`  
**Auditor**: Automated scan + network verification

---

## Executive Summary

| Category          | Count         | Action Required            |
| ----------------- | ------------- | -------------------------- |
| **NixOS Configs** | 4 files       | ‚úÖ Update during migration |
| **hsb1 Runtime**  | 12+ locations | ‚ö†Ô∏è Update Docker/secrets   |
| **hsb0 DNS**      | 2 entries     | ‚úÖ Add hsb1, keep alias    |
| **Unreachable**   | 4 servers     | üîç Check when available    |

---

## 1. Servers Checked

### ‚úÖ Reachable Servers

| Server                  | IP            | Status    | miniserver24 Refs Found |
| ----------------------- | ------------- | --------- | ----------------------- |
| **hsb0**                | 192.168.1.99  | ‚úÖ Online | 2 (DNS entries)         |
| **hsb1** (miniserver24) | 192.168.1.101 | ‚úÖ Online | 12+ locations           |

### ‚ùå Unreachable Servers

| Server            | Status      | Reason                   |
| ----------------- | ----------- | ------------------------ |
| **hsb8**          | ‚ùå Timeout  | SSH connection timed out |
| **csb0**          | ‚ùå DNS fail | Hostname not resolvable  |
| **csb1**          | ‚ùå DNS fail | Hostname not resolvable  |
| **mba-gaming-pc** | ‚ùå DNS fail | Hostname not resolvable  |

---

## 2. NixOS Configuration Files

### 2.1 hsb0/configuration.nix (DNS Server)

**Location**: `hosts/hsb0/configuration.nix` lines 203-204

```nix
# Home automation server + MQTT broker
"192.168.1.101" = [
  "miniserver24"
  "miniserver24.lan"
  "mosquitto"
  "mosquitto.lan"
];
```

**Action**: Add `hsb1` and `hsb1.lan` entries, keep `miniserver24` as alias temporarily.

---

### 2.2 hsb1/configuration.nix (The Server Itself)

| Line     | Reference                            | Type           | Action              |
| -------- | ------------------------------------ | -------------- | ------------------- |
| 1        | `# miniserver24 server for Markus`   | Comment        | Update to hsb1      |
| 200, 217 | MQTT topic comments                  | Comment        | Update topic names  |
| 271-272  | `home/miniserver24/kiosk-vlc-volume` | **FUNCTIONAL** | ‚ö†Ô∏è Update topic     |
| 314      | `hostName = "miniserver24"`          | **HOSTNAME**   | ‚ö†Ô∏è Change to `hsb1` |

---

### 2.3 mba-gaming-pc/configuration.nix

**Location**: Line 62

```nix
"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5... mba@miniserver24" # node-red container ssh calls
```

**Action**: Update comment to `mba@hsb1` (cosmetic only, key remains valid).

---

### 2.4 hsb8/configuration.nix

**Lines 421, 446**: Comments only, referencing miniserver24 as a reference implementation.

**Action**: Update comments to reference hsb1.

---

## 3. Runtime Configuration on hsb1 (miniserver24)

### 3.1 System Files

| File                           | Content                  | Action                       |
| ------------------------------ | ------------------------ | ---------------------------- |
| `/etc/hosts`                   | `127.0.0.2 miniserver24` | Will be regenerated by NixOS |
| `/etc/secrets/mqtt.env`        | `MQTT_HOST=miniserver24` | ‚ö†Ô∏è Update to `hsb1` or IP    |
| `/etc/secrets/tapoC210-00.env` | Comment only             | Update comment               |

### 3.2 Docker Mounts - Icecast

**File**: `/home/mba/docker/mounts/icecast/etc/icecast2/icecast.xml`

```xml
<hostname>miniserver24</hostname>
```

**Action**: Update to `hsb1`.

### 3.3 Docker Mounts - Pixoo Daemon

**File**: `/home/mba/docker/mounts/pixoo-daemon/app/mqtt_commands.sh`

```bash
export MOSQITTO_HOST_MS24=miniserver24
```

**Action**: Update variable name and value.

### 3.4 Docker Mounts - Node-RED (flows.json)

**Critical**: Node-RED flows contain multiple hardcoded references:

| Usage                 | Example                                    | Count |
| --------------------- | ------------------------------------------ | ----- |
| **MQTT Broker**       | `"broker": "miniserver24"`                 | 1     |
| **MQTT Client ID**    | `"clientid": "node red miniserver24"`      | 1     |
| **MQTT Topics**       | `home/miniserver24/kiosk-vlc-volume`       | 2     |
| **Homebridge URL**    | `http://miniserver24:51323`                | 2     |
| **Notification URLs** | `http://miniserver24:8001/notify`          | 2     |
| **Sound file URLs**   | `http://miniserver24:1880/webserver/*.mp3` | 8+    |
| **Function code**     | Various embedded JS                        | 3+    |

**Action**:

1. Export Node-RED flows
2. Find/replace `miniserver24` ‚Üí `hsb1`
3. Re-import flows
4. OR use environment variables for hostnames

---

## 4. hsb0 Runtime (DNS Server)

### /etc/hosts (Generated by NixOS)

```
192.168.1.101 miniserver24 miniserver24.lan mosquitto mosquitto.lan
```

**Action**: This is generated from `configuration.nix`. Update there.

---

## 5. Action Plan

### Phase 1: NixOS Configs (Low Risk)

- [ ] Update `hosts/hsb1/configuration.nix`:
  - [ ] Change `hostName = "hsb1"`
  - [ ] Update MQTT topic to `home/hsb1/kiosk-vlc-volume`
  - [ ] Update comments
- [ ] Update `hosts/hsb0/configuration.nix`:
  - [ ] Add `hsb1` and `hsb1.lan` entries
  - [ ] Keep `miniserver24` as alias (backwards compat)
- [ ] Update `hosts/mba-gaming-pc/configuration.nix`:
  - [ ] Update SSH key comment
- [ ] Update `hosts/hsb8/configuration.nix`:
  - [ ] Update reference comments

### Phase 2: Runtime Configs on hsb1 (Medium Risk)

- [ ] Update `/etc/secrets/mqtt.env`:
  - [ ] Change `MQTT_HOST=hsb1` (or use IP `192.168.1.101`)
- [ ] Update Icecast config
- [ ] Update Pixoo daemon config
- [ ] Update Node-RED flows (biggest task)

### Phase 3: Verify & Test

- [ ] Rebuild hsb0 (DNS changes)
- [ ] Rebuild hsb1 (hostname change)
- [ ] Test MQTT connectivity
- [ ] Test Node-RED flows
- [ ] Verify DNS resolution for both `hsb1` and `miniserver24`

---

## 6. Backwards Compatibility

**Recommendation**: Keep `miniserver24` as a DNS alias for 30 days:

```nix
"192.168.1.101" = [
  "hsb1"
  "hsb1.lan"
  "miniserver24"        # Legacy alias - remove after 2025-12-28
  "miniserver24.lan"    # Legacy alias - remove after 2025-12-28
  "mosquitto"
  "mosquitto.lan"
];
```

This allows gradual migration of any external references.

---

## 7. Servers to Re-Check

When these servers become available, verify no `miniserver24` references exist:

- [ ] **hsb8**: Check `/etc/hosts`, Docker configs
- [ ] **csb0**: Check `/etc/hosts`, any automation scripts
- [ ] **csb1**: Check `/etc/hosts`, any automation scripts
- [ ] **mba-gaming-pc**: Check `/etc/hosts`

---

## Appendix: Raw Scan Results

### hsb0 /etc/hosts

```
192.168.1.101 miniserver24 miniserver24.lan mosquitto mosquitto.lan
```

### hsb1 (miniserver24) hostname

```
miniserver24
```

### hsb1 /etc/hosts

```
127.0.0.2 miniserver24
```

### hsb1 /etc/secrets/mqtt.env

```
MQTT_HOST=miniserver24
```
