services:
  restic-cron-hetzner:
    build: ./restic-cron
    container_name: restic-cron-hetzner
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/lib/AdGuardHome:/backup/var/lib/AdGuardHome:ro
      - /var/lib/ncps:/backup/var/lib/ncps:ro
      - /etc:/backup/etc:ro
      # Use SSH key from agenix (shared with csb0)
      - /run/agenix/restic-hetzner-ssh-key:/root/.ssh/id_rsa:ro
      - ./restic-cron/ssh_known_hosts:/root/.ssh/known_hosts:ro
      # BIND MOUNTS: Local scripts override container defaults
      - ./restic-cron/hetzner/run_backup.sh:/usr/local/bin/run_backup.sh:ro
      - ./restic-cron/hetzner/run_check.sh:/usr/local/bin/run_check.sh:ro
      - ./restic-cron/hetzner/run_cleanup.sh:/usr/local/bin/run_cleanup.sh:ro
      - ./restic-cron/hetzner/start_cron.sh:/usr/local/bin/start_cron.sh:ro
    environment:
      # Target shared sub1 but in a dedicated folder /hsb0
      RESTIC_REPOSITORY: "sftp:u387549-sub1@u387549.your-storagebox.de:23/hsb0"
      MAIL_SUBJECT: "ðŸ’¾ Restic backup report (hsb0)"
      CRON_BACKUP_EXPRESSION: "0 2 * * *" # 2:00am
    env_file:
      # Load RESTIC_PASSWORD from agenix (shared with csb0)
      - /run/agenix/restic-hetzner-env
    labels:
      - com.centurylinklabs.watchtower.enable=false
      - traefik.enable=false

  ncps:
    image: kalbasit/ncps:latest
    container_name: ncps
    restart: unless-stopped
    ports:
      - "8501:8501"
    volumes:
      - /var/lib/ncps:/storage
      - /run/agenix/ncps-key:/run/secrets/ncps-key:ro
    environment:
      - NCPS_LOG_LEVEL=info
      - NCPS_SERVE=true
      - NCPS_CACHE_HOSTNAME=hsb0.lan
      - NCPS_CACHE_DATA_PATH=/storage
      - NCPS_CACHE_DATABASE_URL=sqlite:/storage/db.sqlite
      - NCPS_CACHE_TEMP_PATH=/tmp
      - NCPS_SERVER_ADDR=0.0.0.0:8501
      - NCPS_CACHE_ALLOW_PUT_VERB=true
      - NCPS_CACHE_MAX_SIZE=50G
      - NCPS_CACHE_LRU_SCHEDULE=0 3 * * *
      - NCPS_CACHE_SECRET_KEY_PATH=/run/secrets/ncps-key
      - NCPS_UPSTREAM_CACHE=https://cache.nixos.org,https://nix-community.cachix.org
      - NCPS_UPSTREAM_PUBLIC_KEY=cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=,nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
