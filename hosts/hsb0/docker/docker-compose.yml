services:
  restic-cron-hetzner:
    build: ./restic-cron
    container_name: restic-cron-hetzner
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/lib/AdGuardHome:/backup/var/lib/AdGuardHome:ro
      - /var/lib/ncps:/backup/var/lib/ncps:ro
      - /etc:/backup/etc:ro
      # Use SSH key from agenix (shared with csb0)
      - /run/agenix/restic-hetzner-ssh-key:/root/.ssh/id_rsa:ro
      - ./restic-cron/ssh_known_hosts:/root/.ssh/known_hosts:ro
      # BIND MOUNTS: Local scripts override container defaults
      - ./restic-cron/hetzner/run_backup.sh:/usr/local/bin/run_backup.sh:ro
      - ./restic-cron/hetzner/run_check.sh:/usr/local/bin/run_check.sh:ro
      - ./restic-cron/hetzner/run_cleanup.sh:/usr/local/bin/run_cleanup.sh:ro
      - ./restic-cron/hetzner/start_cron.sh:/usr/local/bin/start_cron.sh:ro
    environment:
      # Target shared sub1 but in a dedicated folder /hsb0
      RESTIC_REPOSITORY: "sftp:u387549-sub1@u387549.your-storagebox.de:23/hsb0"
      MAIL_SUBJECT: "ðŸ’¾ Restic backup report (hsb0)"
      CRON_BACKUP_EXPRESSION: "0 2 * * *" # 2:00am
    env_file:
      # Load RESTIC_PASSWORD from agenix (shared with csb0)
      - /run/agenix/restic-hetzner-env
    labels:
      - com.centurylinklabs.watchtower.enable=false
      - traefik.enable=false

  smtp:
    image: namshi/smtp
    restart: unless-stopped
    environment:
      - TZ=Europe/Vienna
      - SMARTHOST_ADDRESS=mail.hover.com
      - SMARTHOST_PORT=587
      - SMARTHOST_USER=markus@barta.com
      - SMARTHOST_ALIASES=*
      - RELAY_NETWORKS=:172.0.0.0/8
    labels:
      - traefik.enable=false
      - com.centurylinklabs.watchtower.enable=false

  openclaw-merlin:
    build: ./openclaw-merlin
    container_name: openclaw-merlin
    restart: unless-stopped
    network_mode: host
    volumes:
      - /var/lib/openclaw-merlin/data:/home/node/.openclaw:rw
      - /var/lib/openclaw-merlin/vdirsyncer:/home/node/.config/vdirsyncer:rw
      - /var/lib/openclaw-merlin/khal:/home/node/.config/khal:rw
      - /var/lib/openclaw-merlin/gogcli:/home/node/.config/gogcli:rw
      # Git-managed config (read-only source, copied to data volume at boot)
      - ./openclaw-merlin/openclaw.json:/home/node/.openclaw-config/openclaw.json:ro
      # Secrets (read-only, mounted from agenix)
      - /run/agenix/hsb0-openclaw-telegram-token:/run/secrets/telegram-token:ro
      - /run/agenix/hsb0-openclaw-gateway-token:/run/secrets/gateway-token:ro
      - /run/agenix/hsb0-openclaw-openrouter-key:/run/secrets/openrouter-key:ro
      - /run/agenix/hsb0-openclaw-brave-key:/run/secrets/brave-key:ro
      - /run/agenix/hsb0-openclaw-hass-token:/run/secrets/hass-token:ro
      - /run/agenix/hsb0-openclaw-opus-gateway:/home/node/.openclaw/credentials/opus-gateway.env:ro
      - /run/agenix/hsb0-openclaw-github-pat:/run/secrets/github-pat:ro
      # TODO: Uncomment when Azure AD app (Merlin-AI-hsb0-cal) is created
      # - /run/agenix/hsb0-openclaw-m365-cal-client-id:/run/secrets/m365-cal-client-id:ro
      # - /run/agenix/hsb0-openclaw-m365-cal-tenant-id:/run/secrets/m365-cal-tenant-id:ro
      # - /run/agenix/hsb0-openclaw-m365-cal-client-secret:/run/secrets/m365-cal-client-secret:ro
    environment:
      GOG_KEYRING_BACKEND: "file"
      GOG_ACCOUNT: "markus@barta.com"
    env_file:
      - /run/agenix/hsb0-gogcli-keyring-password
    # OpenClaw reads API keys from env vars directly.
    # Secrets are mounted from agenix (mode 444 in NixOS config).
    # The entrypoint reads them into env vars, then execs as node user.
    user: "node"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        export TELEGRAM_BOT_TOKEN=$$(cat /run/secrets/telegram-token)
        export OPENCLAW_GATEWAY_TOKEN=$$(cat /run/secrets/gateway-token)
        export OPENROUTER_API_KEY=$$(cat /run/secrets/openrouter-key)
        export BRAVE_API_KEY=$$(cat /run/secrets/brave-key)
        export GITHUB_PAT=$$(cat /run/secrets/github-pat)

        # Deploy git-managed config (backup existing, then overwrite)
        CONFIG_SRC=/home/node/.openclaw-config/openclaw.json
        CONFIG_DST=/home/node/.openclaw/openclaw.json
        if [ -f "$$CONFIG_DST" ]; then
          BACKUP="$$CONFIG_DST.bak.$$(date +%Y%m%d-%H%M%S)"
          cp "$$CONFIG_DST" "$$BACKUP"
          echo "[config] Backed up existing config to $$BACKUP"
        fi
        cp "$$CONFIG_SRC" "$$CONFIG_DST"
        echo "[config] Deployed git-managed openclaw.json"

        # Initialize workspace from git if not already cloned
        WORKSPACE_DIR=/home/node/.openclaw/workspace
        if [ ! -d "$$WORKSPACE_DIR/.git" ]; then
          echo "Cloning workspace from GitHub..."
          rm -rf "$$WORKSPACE_DIR"
          git clone https://$$GITHUB_PAT@github.com/markus-barta/oc-workspace-merlin.git "$$WORKSPACE_DIR"
          cd "$$WORKSPACE_DIR"
          git config user.name "Merlin AI"
          git config user.email "merlin-ai-mba@users.noreply.github.com"
        else
          echo "Workspace already cloned, pulling latest..."
          cd "$$WORKSPACE_DIR"
          git config user.name "Merlin AI"
          git config user.email "merlin-ai-mba@users.noreply.github.com"
          git pull --ff-only || echo "Pull failed or conflicts, continuing..."
        fi

        # Daily auto-push safety net (runs in background, every 24h)
        (while true; do
          sleep 86400
          cd "$$WORKSPACE_DIR"
          if [ -n "$$(git status --porcelain)" ]; then
            echo "[auto-push] Uncommitted workspace changes detected, pushing..."
            git add -A
            git commit -m "auto: daily workspace sync"
            git push || echo "[auto-push] Push failed, will retry next cycle"
          fi
        done) &

        exec openclaw gateway --port 18789
    labels:
      - com.centurylinklabs.watchtower.enable=false

  ncps:
    image: kalbasit/ncps:latest
    container_name: ncps
    restart: unless-stopped
    ports:
      - "8501:8501"
    volumes:
      - /var/lib/ncps:/storage
      - /run/agenix/ncps-key:/run/secrets/ncps-key:ro
    entrypoint: ["/bin/ncps"]
    command:
      - serve
      - --cache-hostname=hsb0.lan
      - --cache-database-url=sqlite:/storage/db.sqlite?_pragma=foreign_keys(1)
      - --cache-storage-local=/storage
      - --cache-temp-path=/tmp
      - --server-addr=0.0.0.0:8501
      - --cache-allow-put-verb
      - --cache-max-size=50G
      - --cache-lru-schedule=0 3 * * *
      - --cache-secret-key-path=/run/secrets/ncps-key
      - --cache-upstream-url=https://cache.nixos.org
      - --cache-upstream-url=https://nix-community.cachix.org
      - --cache-upstream-public-key=cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
      - --cache-upstream-public-key=nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
    environment:
      - NCPS_LOG_LEVEL=info
      - ANALYTICS_REPORTING_ENABLED=false
