# NixFleet - Docker Compose for csb1 deployment
#
# Deploy with: docker compose up -d
#
# Environment variables (set in .env or docker-compose override):
#   NIXFLEET_PASSWORD_HASH  - SHA256 hash of admin password
#   NIXFLEET_TOTP_SECRET    - Base32-encoded TOTP secret (optional)
#   NIXFLEET_API_TOKEN      - Token for agent authentication
#   NIXFLEET_SESSION_SECRET - Random string for session signing

services:
  nixfleet:
    build: .
    container_name: nixfleet
    restart: unless-stopped
    environment:
      - NIXFLEET_DATA_DIR=/data
      - NIXFLEET_PASSWORD_HASH=${NIXFLEET_PASSWORD_HASH}
      - NIXFLEET_TOTP_SECRET=${NIXFLEET_TOTP_SECRET:-}
      - NIXFLEET_API_TOKEN=${NIXFLEET_API_TOKEN}
      - NIXFLEET_SESSION_SECRET=${NIXFLEET_SESSION_SECRET}
    volumes:
      - nixfleet-data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nixfleet.rule=Host(`fleet.barta.cm`)"
      - "traefik.http.routers.nixfleet.entrypoints=websecure"
      - "traefik.http.routers.nixfleet.tls.certresolver=letsencrypt"
      - "traefik.http.services.nixfleet.loadbalancer.server.port=8000"
    networks:
      - traefik

volumes:
  nixfleet-data:

networks:
  traefik:
    external: true
